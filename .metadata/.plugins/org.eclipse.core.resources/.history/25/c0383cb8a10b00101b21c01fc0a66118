package com.project.mapper;

import java.util.List;
import java.util.Map;

import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Options;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

import com.project.model.Favorites;
import com.project.model.Inquiry;
import com.project.model.Notification;
import com.project.model.User;
import com.project.model.krhBoardVO;

@Mapper
public interface UserMapper {

    // ğŸ”¹ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ì•„ì´ë”” ì°¾ê¸°
    @Select("SELECT email FROM users WHERE name = #{name} AND phone_number = #{phoneNumber}")
    String findEmailByNameAndPhone(@Param("name") String name, @Param("phoneNumber") String phoneNumber);

    // ğŸ”¹ í•´ë‹¹ ì´ë©”ì¼ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ê°€ì§„ ìœ ì € ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    @Select("SELECT COUNT(*) FROM users WHERE email = #{email} AND phone_number = #{phoneNumber}")
    int countUserByEmailAndPhone(@Param("email") String email, @Param("phoneNumber") String phoneNumber);

    // ğŸ”¹ íŠ¹ì • ì´ë©”ì¼ë¡œ ìœ ì € ì¡°íšŒ (Optional)
    @Select("SELECT * FROM users WHERE email = #{email}")
    User findByEmail(String email);
    @Update("UPDATE users SET password = #{password} WHERE email = #{email}")
    void updatePassword(@Param("email") String email, @Param("password") String password);
    @Insert("INSERT INTO verification_codes (email, code, created_at) " +
            "VALUES (#{email}, #{code}, NOW()) " +
            "ON DUPLICATE KEY UPDATE code = VALUES(code), created_at = NOW()")
    void saveVerificationCode(@Param("email") String email, @Param("code") String code);
    @Insert("INSERT INTO verification_codes (email, code, created_at) VALUES (#{email}, #{code}, NOW())")
    void insertVerificationCode(@Param("email") String email, @Param("code") String code);

    @Update("UPDATE verification_codes SET code = #{code}, created_at = NOW() WHERE email = #{email}")
    int updateVerificationCode(@Param("email") String email, @Param("code") String code);

    @Select("SELECT code FROM verification_codes WHERE email = #{email} ORDER BY created_at DESC LIMIT 1")
    String getVerificationCode(@Param("email") String email);

    @Select("SELECT * FROM users")
    List<User> findAllUsers();
    // âœ… íŠ¹ì • IDë¡œ ë¬¸ì˜ ì¡°íšŒ (ì´ë©”ì¼ í¬í•¨)
    @Select("SELECT * FROM inquiries WHERE id = #{id}")
    Inquiry findById(Long id);
    // âœ… íŠ¹ì • ë¬¸ì˜ê¸€ì´ í•´ë‹¹ ì‚¬ìš©ìì˜ ê²ƒì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
    @Select("SELECT COUNT(*) FROM inquiries WHERE id = #{inquiryId} AND user_email = #{email}")
    int isInquiryOwner(@Param("inquiryId") Long inquiryId, @Param("email") String email);
    
    @Delete("DELETE FROM verification_codes WHERE email = #{email}")
    void deleteVerificationCode(@Param("email") String email);
    // ğŸ”¹ íšŒì›ê°€ì… (íœ´ëŒ€í° ë²ˆí˜¸ í¬í•¨)
    @Insert("INSERT INTO users (email, password, name, phone_number, profile_image, role, is_verified, created_at) " +
            "VALUES (#{email}, #{password}, #{name}, #{phoneNumber}, #{profileImage}, #{role}, #{isVerified}, NOW())")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    void registerUser(User user);
 // UserMapper.javaì— ì¶”ê°€
    @Select("SELECT password FROM users WHERE email = #{email}")
    String getHashedPasswordByEmail(@Param("email") String email);

    // âœ… íŠ¹ì • ì´ë©”ì¼ì˜ ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ
    @Select("SELECT password FROM users WHERE email = #{email}")
    String getPasswordByEmail(@Param("email") String email);
    // âœ… ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
    @Select("SELECT COUNT(*) FROM users WHERE email = #{email}")
    int checkEmailExists(@Param("email") String email);

    // âœ… íŠ¹ì • íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ìœ ì € ì°¾ê¸° (ê¸°ì¡´ ë°©ì‹)
    @Select("SELECT COUNT(*) FROM users WHERE REPLACE(phone_number, '-', '') = REPLACE(#{phoneNumber}, '-', '')")
    int countByPhoneNumber(String phoneNumber);
    // ğŸ”¹ ë¡œê·¸ì¸ (íœ´ëŒ€í° ë²ˆí˜¸ í¬í•¨)
    @Select("SELECT * FROM users WHERE email = #{email} AND password = #{password}")
    User login(@Param("email") String email, @Param("password") String password);

    // ğŸ”¹ ìœ ì € ì •ë³´ ì¡°íšŒ (íœ´ëŒ€í° ë²ˆí˜¸ í¬í•¨)
    @Select("SELECT id, email, password, name, phone_number, profile_image, role, is_verified, created_at FROM users WHERE email = #{email}")
    User getUserByEmail(@Param("email") String email);


    // ğŸ”¹ ìœ ì € ì •ë³´ ìˆ˜ì • (ì´ë¦„, í”„ë¡œí•„ ì´ë¯¸ì§€, íœ´ëŒ€í° ë²ˆí˜¸)

    @Update({
        "<script>",
        "UPDATE users SET",
        "<if test='password != null and password != \"\"'> password = #{password}, </if>",
        "name = #{name},",
        "phone_number = #{phoneNumber}",
        "<if test='profileImage != null'>, profile_image = #{profileImage} </if>",
        "WHERE email = #{email}",
        "</script>"
    })
    void updateUser(User user);

    // ğŸ”¹ íšŒì› íƒˆí‡´ ìš”ì²­ ì €ì¥
    @Insert("INSERT INTO user_deletion_requests (email, reason, created_at) " +
            "VALUES (#{email}, #{reason}, NOW())")
    void requestAccountDeletion(@Param("email") String email, @Param("reason") String reason);

    // ğŸ”¹ ìœ ì € ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ
    @Select("SELECT * FROM notifications WHERE receiver_email = #{email}")
    List<Notification> getUserNotifications(@Param("email") String email);

    // ğŸ”¹ ìœ ì € ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
    @Update("UPDATE notifications SET is_read = TRUE WHERE id = #{notificationId} AND receiver_email = #{email}")
    void markUserNotificationAsRead(@Param("notificationId") Long notificationId, @Param("email") String email);
  
    // âœ… íŠ¹ì • ì•Œë¦¼ ì‚­ì œ
    @Delete("DELETE FROM notifications WHERE id = #{id}")
    void deleteUserNotification(@Param("id") Long id);



    // ğŸ”¹ íŠ¹ì • ìœ ì €ì˜ ê²Œì‹œë¬¼ ì¡°íšŒ
    @Select("SELECT boardId, title, createdAt FROM board WHERE authorEmail = #{email}")
    List<krhBoardVO> findBoardsByUserEmail(@Param("email") String email);

    /** âœ… ìœ ì € ì¦ê²¨ì°¾ê¸° ê´€ë ¨ ê¸°ëŠ¥ **/
    @Select("""
    	    SELECT 
    	        r.recipes_id AS recipeId,
    	        r.foodName,
    	        r.foodImg
    	    FROM favorite f
    	    JOIN recipes r ON f.recipe_id = r.recipes_id
    	    WHERE f.user_id = #{userId}
    	""")
    	List<Map<String, Object>> getFavoriteRecipesByUser(Long userId);

    
    // ìœ ì €ì˜ ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì¡°íšŒ
    @Select("SELECT * FROM favorite WHERE user_id = #{userId}")
    List<Favorites> getFavoritesByUserId(Long userId);

    // ì¦ê²¨ì°¾ê¸° ì‚­ì œ
 // ğŸ”¹ ì‚­ì œëœ í–‰ ìˆ˜(int)ë¥¼ ë°˜í™˜í•˜ì—¬ ì‚­ì œ ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸ ê°€ëŠ¥
    @Delete("DELETE FROM favorite WHERE user_id = #{userId} AND recipe_id = #{recipeId}")
    int removeFavorite(Long userId, Long recipeId);

    // ğŸ”¹ 1:1 ë¬¸ì˜ ë“±ë¡
    @Insert("INSERT INTO inquiries (user_email, title, content, created_at) VALUES (#{userEmail}, #{title}, #{content}, NOW())")
    void insertInquiry(Inquiry inquiry);

    // ğŸ”¹ 1:1 ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ
    @Select("SELECT * FROM inquiries WHERE user_email = #{email}")
    List<Inquiry> getUserInquiries(@Param("email") String email);

    // ğŸ”¹ 1:1 ë¬¸ì˜ ì‚­ì œ
    @Delete("DELETE FROM inquiries WHERE id = #{inquiryId} AND user_email = #{email}")
    void deleteUserInquiry(@Param("inquiryId") Long inquiryId, @Param("email") String email);
    
    // ë¡œê·¸ì¸ ê¸°ë¡ ì €ì¥
    @Update("UPDATE users SET last_login = NOW() WHERE id = #{userId}")
    void updateLastLogin(Long userId);
    @Update("""
    	    UPDATE users 
    	    SET login_count = login_count + 1, 
    	        last_login_update = NOW() 
    	    WHERE email = #{email} 
    	        AND (last_login_update IS NULL OR last_login_update < NOW() - INTERVAL 1 HOUR)
    	""")
    	void incrementLoginCount(@Param("email") String email);
    // ë¡œê·¸ì¸ ê¸°ë¡ ì €ì¥ 
    @Insert("INSERT INTO login_history (user_id, login_time) VALUES (#{userId}, NOW())")
    void insertLoginHistory(@Param("userId") Long userId);

}